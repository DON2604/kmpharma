name: Build Android (APK + AAB + Release)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout repository (full history needed for tags)
      # --------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Java setup (Android Gradle Plugin requirement)
      # --------------------------------------------------
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # --------------------------------------------------
      # Flutter setup
      # --------------------------------------------------
      - name: Set up Flutter
        uses: flutter-actions/setup-flutter@v2
        with:
          version: '3.35.5'

      # --------------------------------------------------
      # Auto-increment Flutter build number
      # --------------------------------------------------
      - name: Auto increment version
        working-directory: kmpharma
        run: |
          VERSION_LINE=$(grep '^version:' pubspec.yaml)
          VERSION=$(echo $VERSION_LINE | awk '{print $2}')

          BASE_VERSION=$(echo $VERSION | cut -d+ -f1)
          BUILD_NUMBER=$(echo $VERSION | cut -d+ -f2)

          if [ -z "$BUILD_NUMBER" ]; then
            BUILD_NUMBER=1
          else
            BUILD_NUMBER=$((BUILD_NUMBER + 1))
          fi

          NEW_VERSION="$BASE_VERSION+$BUILD_NUMBER"

          sed -i "s/^version:.*/version: $NEW_VERSION/" pubspec.yaml
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

          echo "Updated version to $NEW_VERSION"

      # --------------------------------------------------
      # Commit version bump back to repository
      # --------------------------------------------------
      - name: Commit version bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add kmpharma/pubspec.yaml
          git commit -m "ci: bump version [skip ci]" || echo "No changes to commit"
          git push

      # --------------------------------------------------
      # Install Flutter dependencies
      # --------------------------------------------------
      - name: Install dependencies
        working-directory: kmpharma
        run: flutter pub get

      # --------------------------------------------------
      # Build APK (Release)
      # --------------------------------------------------
      - name: Build APK
        working-directory: kmpharma
        run: flutter build apk --release

      # --------------------------------------------------
      # Build AAB (Release)
      # --------------------------------------------------
      - name: Build AAB
        working-directory: kmpharma
        run: flutter build appbundle --release

      # --------------------------------------------------
      # Rename outputs with version
      # --------------------------------------------------
      - name: Rename build outputs
        run: |
          mv kmpharma/build/app/outputs/flutter-apk/app-release.apk \
             kmpharma/build/app/outputs/flutter-apk/kmpharma-v${{ env.NEW_VERSION }}.apk

          mv kmpharma/build/app/outputs/bundle/release/app-release.aab \
             kmpharma/build/app/outputs/bundle/release/kmpharma-v${{ env.NEW_VERSION }}.aab

      # --------------------------------------------------
      # Create GitHub Release + upload artifacts
      # --------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: kmpharma v${{ env.NEW_VERSION }}
          body: |
            ðŸš€ Automated Android Release

            Version: ${{ env.NEW_VERSION }}

            Included:
            - Release APK
            - Android App Bundle (AAB)
          files: |
            kmpharma/build/app/outputs/flutter-apk/kmpharma-v${{ env.NEW_VERSION }}.apk
            kmpharma/build/app/outputs/bundle/release/kmpharma-v${{ env.NEW_VERSION }}.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
